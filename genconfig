#!/bin/bash

CONFIG=/cfg/config
. $CONFIG

genconfig() 
{
	while IFS= read -r line; do
		if [ "${line:0:1}" = "#"  ]; then
			echo "$line"
			continue
		fi      
		while [[ "$line" = *@@@*%%%* ]]; do
			VARNAME=""
			VARNAME="${line#*@@@}"
			VARNAME="${VARNAME%%%%%*}"
			VARVALUE=""
			[ "$VARNAME" != "" ] && eval VARVALUE="\$$VARNAME"
			line="${line//@@@$VARNAME%%%/$VARVALUE}"
		done
		echo "$line"
	done < $tmpltfile >$conffile
}

gen_pppoe_config() {
	# pppoe-server-options
	conffile=/etc/ppp/pppoe-server-options
	tmpltfile=/etc/ppp/pppoe-server-options.tmplt

	pppoe_server_name="${pppoe_server[name]}"
	ppp_server_ip="${app[ppp-server.ip]}"

	genconfig
}

gen_pptpd_config() {
	# pptpd.conf
	conffile=/etc/ppp/options.pptpd
	tmpltfile=/etc/ppp/options.pptpd.tmplt

	ppp_server_ip="${app[ppp-server.ip]}"
	require_mppe="${pptpd[mppe]}"
	require_mppe_128_str=
	require_mppe_40_str=
	mppe_optional_str=
	nomppe_str=
	case $require_mppe in
	nomppe )
		nomppe_str="nomppe"
		;;
	require-mppe )
		require_mppe_40_str="require-mppe-40"
		require_mppe_128_str="require-mppe-128"
		;;
	#mppe-optional by default
	* )
		require_mppe_40_str="require-mppe-40"
		require_mppe_128_str="require-mppe-128"
		mppe_optional_str="mppe-optional"
		;;
	esac

	genconfig
}

gen_openl2tpd_config() {
	# openl2tpd.conf
	conffile=/etc/ppp/openl2tpd.conf
	tmpltfile=/etc/ppp/openl2tpd.conf.tmplt
	openl2tpd_addr="${app[ppp-server.ip]}"

	genconfig
}

gen_radius_config() {
	# radiusclient и servers
	acctserver="${radclient[acctserver]}"
	authserver="${radclient[authserver]}"
	server_ip=${authserver%%:*}
	secret="${radclient[secret]}"
	nas_identifier="${radclient[nas_identifier]}"

	conffile=/etc/radiusclient/servers
	tmpltfile=/etc/radiusclient/servers.tmplt

	genconfig
	conffile=/etc/radiusclient/radiusclient.conf
	tmpltfile=/etc/radiusclient/radiusclient.conf.tmplt

	genconfig
}


gen_bind_config() {
	# bind
	# declare leth_list
	for iface in seq 0 1 2 3 4 5 6 7 8 9; do
		if [ "${network[if$iface.role]}" = 'Local' ]; then
			leth_list="$leth_list ${network[if$iface.ip]%%/*};"
		fi
	done

	# не нужно, надо просто добавить настроенный защищенный ip
	# а вот хрен. нужно.
	if [ "${pptpd[enabled]}" = '1' -o "${pppoe_server[enabled]}" = '1' -o "${openl2tpd[enabled]}" = '1' ]; then
		leth_list="$leth_list ${app[ppp-server.ip]};"
	fi

	conffile=/etc/named.conf
	tmpltfile=/etc/named.conf.tmplt

	genconfig
}


gen_hosts_file() {
	# hosts
	app_ip=${app[ppp-server-ip]%%/*}
	host_name=$(hostname)
	conffile=/etc/hosts
	tmpltfile=/etc/hosts.tmplt

	genconfig
}

gen_quagga_config() {
	# quagga
	quagga_hostname=${srv['quagga.hostname']}
	quagga_password=${srv['quagga.password']}
	quagga_enable_password=${srv['quagga.enable_password']}
	conffile=/etc/quagga/ospfd.conf
	tmpltfile=/etc/quagga/ospfd.conf.tmplt

	genconfig
}

main() {
	gen_pppoe_config
	gen_pptpd_config
	# gen_openl2tpd_config
	gen_radius_config
	# gen_bind_config
	gen_hosts_file
	# gen_quagga_config
}

main $@
